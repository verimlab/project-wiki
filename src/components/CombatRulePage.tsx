// src/components/CombatRulePage.tsx

import React, { useEffect, useState } from 'react';
import { Link } from 'react-router-dom';
import { onAuthStateChanged, getIdTokenResult } from 'firebase/auth';
import type { User } from 'firebase/auth';
import { doc, getDoc } from 'firebase/firestore';
import { auth, db } from '../firebase';
import './CombatRulePage.css'; // Убедись, что этот CSS-файл существует

const CombatRulePage: React.FC = () => {
  const [, setUser] = useState<User | null>(null);
  const [, setRole] = useState<'gm' | 'player' | null>(null);

  useEffect(() => {
    const unsubscribe = onAuthStateChanged(auth, async (nextUser) => {
      setUser(nextUser);
      if (!nextUser) {
        setRole(null);
        return;
      }

      const resolveRole = async () => {
        try {
          const tokenResult = await getIdTokenResult(nextUser, true);
          const claimRole = tokenResult.claims.role;
          if (claimRole === 'gm' || claimRole === 'player') {
            return claimRole as 'gm' | 'player';
          }

          const userDoc = await getDoc(doc(db, 'users', nextUser.uid));
          if (userDoc.exists()) {
            const data = userDoc.data() as { role?: unknown };
            if (data.role === 'gm' || data.role === 'player') {
              return data.role;
            }
          }
        } catch (tokenError) {
          console.error(tokenError);
        }
        return 'player' as const;
      };

      const resolved = await resolveRole();
      setRole(resolved);
    });
    return () => unsubscribe();
  }, []);

  return (
    <div className="hw-root">


      <main className="hw-main article-main">
        <div className="article-container">
          <header className="article-header">
            <Link to="/rules" className="article-back-link">
              <i className="fa-solid fa-arrow-left" />
              Назад к правилам
            </Link>
            <h1>Бой</h1>
            <p className="article-intro">
              Полный свод правил по перемещению, действиям, бонусным действиям и
              реакциям в бою.
            </p>
          </header>

          <article className="article-content">
            {/* ▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼
              
                ИСПРАВЛЕННАЯ ВЕРСИЯ БЕЗ [CITE] МУСОРА
              
              ▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲
            */}

            <h2>
              <i className="fa-solid fa-person-running" /> Движение
            </h2>

            <h3>
              <i className="fa-solid fa-shoe-prints" /> Передвижение
            </h3>
            <ol>
              <li>
                Вы можете проходить сквозь пространство невраждебных существ.
              </li>
              <li>
                Сквозь пространство враждебного существа можно пройти только
                если его размер как минимум на две категории больше или меньше
                вашего. (<em>
                  Крохотный-Очень маленький-Маленький-Средний-Большой-Очень
                  большой-Гигантский-Громадный-Колоссальный
                </em>)
              </li>
              <li>
                Пространство других существ является для вас{' '}
                <strong>труднопроходимой местностью</strong>.
              </li>
              <li>
                Вне зависимости от того, дружественное существо или нет, вы не
                можете добровольно закончить перемещение в его пространстве.
              </li>
            </ol>

            <h3>
              <i className="fa-solid fa-person-swimming" /> Лазанье, плаванье и
              ползанье
            </h3>
            <ol>
              <li>
                Во время лазания и плавания каждый фут перемещения стоит в два
                раза больше, если у существа нет скорости лазания или
                плавания.
              </li>
              <li>
                Если местность подразумевает трудности во время лазания и
                плавания то мастер может запросить соответствующую проверку.
              </li>
              <li>
                Для перемещения в положении лёжа нужно ползти. (<em>
                  См. также "Лежание ничком"
                </em>)
              </li>
            </ol>

            <h3>
              <i className="fa-solid fa-person-falling" /> Лежание ничком
            </h3>
            <ol>
              <li>
                Вы можете упасть ничком, не тратя скорость. Вставание требует
                больше усилий, для него требуется потратить{' '}
                <strong>половину скорости</strong>.
              </li>
              <li>Вы не можете вставать, если ваша скорость равна 0.</li>
            </ol>

            <h3>
              <i className="fa-solid fa-mountain" /> Прыжок в высоту
            </h3>
            <ol>
              <li>
                <strong>С разбега (min 10 футов):</strong> Вы поднимаетесь в
                воздух на количество футов, равное ваш показатель
                характеристики Ловкости + Силы.
              </li>
              <li>
                <strong>Без разбега:</strong> Вы прыгаете на половину этой
                дистанции.
              </li>
              <li>Руки можно вытянуть вверх на половину своего роста.</li>
            </ol>
            <p>
              <em>
                (В некоторых случаях Мастер может позволить совершить проверку
                Атлетики или Акробатики чтобы прыгнуть выше, чем обычно.)
              </em>
            </p>

            <h3>
              <i className="fa-solid fa-person-walking-arrow-right" /> Прыжок в
              длину
            </h3>
            <ol>
              <li>
                <strong>С разбега (min 10 футов):</strong> Вы перемещаетесь на
                количество футов, равное значению Силы умноженное на 3.
              </li>
              <li>
                <strong>Без разбега:</strong> Вы прыгаете на половину этой
                дистанции.
              </li>
              <li>
                Каждый фут, на который вы перенеслись прыжком, учитывается при
                подсчёте перемещения (и вы не можете его превысить).
              </li>
              <li>
                Если Мастер решит, вы должны преуспеть в проверке Силы
                (Атлетика) чтобы перепрыгнуть через препятствие (иначе вы
                ударяетесь об него).
              </li>
              <li>
                Если вы приземляетесь в{' '}
                <strong>труднопроходимую местность</strong>, вы должны преуспеть в
                проверке Ловкости (Акробатика) Сл 10, чтобы приземлиться на
                ноги. В противном случае вы падаете ничком.
              </li>
            </ol>

            <h3>
              <i className="fa-solid fa-road-spikes" /> Труднопроходимая
              местность
            </h3>
            <ol>
              <li>
                Каждый фут перемещения по труднопроходимой местности стоит 1
                дополнительный фут.
              </li>
              <li>
                Это правило действует, даже если на место действуют несколько
                эффектов, делающих его труднопроходимым.
              </li>
            </ol>

            <h3>
              <i className="fa-solid fa-person-running" /> Движение в захвате
            </h3>
            <p>
              Если вы перемещаетесь во время захвата, вы можете тащить или
              нести захваченное существо вместе с собой, но ваша скорость
              уменьшается вдвое, если только существо не меньше вас как
              минимум на две категории.
            </p>

            <h3>
              <i className="fa-solid fa-horse" /> Посадка в седло и спешивание
            </h3>
            <ol>
              <li>
                Во время перемещения вы можете сесть в седло существа (в
                пределах 5 футов) или спешиться. Это стоит количество
                перемещения, равного <strong>половине скорости</strong> (например, 15
                футов при скорости 30).
              </li>
              <li>
                Вы не можете сесть в седло, если у вас осталось меньше
                перемещения, чем нужно, или если ваша скорость равна 0.
              </li>
              <li>
                Если скакуна перемещают против его воли, вы должны преуспеть
                в спасброске Ловкости Сл 10, иначе вы упадёте со скакуна
                ничком.
              </li>
              <li>
                Если ваш скакун сбивается с ног, вы можете{' '}
                <strong>реакцией</strong> спешиться и приземлиться на ноги. В
                противном случае вы падаете ничком.
              </li>
            </ol>

            <h3>
              <i className="fa-solid fa-feather" /> Перемещение полётом
            </h3>
            <p>
              Если летающее существо сбито с ног, его скорость уменьшается до
              0, или оно по какой-то другой причине теряет способность
              перемещаться, оно падает, если только не может парить или не
              летает за счёт магии.
            </p>

            <h3>
              <i className="fa-solid fa-dice" /> Импровизация (Движение)
            </h3>
            <p>
              Когда вы хотите совершить движение, не описанное в правилах,
              Мастер решает возможно ли это и назначает Сл проверки, если
              проверка требуется.
            </p>

            {/* ---------- ДЕЙСТВИЯ ---------- */}

            <h2 className="article-section-break">
              <i className="fa-solid fa-hand" /> Действия
            </h2>

            <h3>
              <i className="fa-solid fa-gavel" /> Атака
            </h3>
            <ol>
              <li>
                Этим действием вы совершаете одну рукопашную или
                дальнобойную атаку оружием. Каждая такая атака использует
                отдельный бросок и может иметь другую цель.
              </li>
              <li>Между основной и дополнительной атакой можно двигаться.</li>
              <li>
                Когда вы атакуете лёгким рукопашным оружием, вы можете
                использовать оружие во второй руке, чтобы совершить{' '}
                <strong>бонусную атаку</strong> (см. ниже).
              </li>
            </ol>
            <p>
              <em>
                (Преимущество: атака против слепых, парализованных,
                окаменевших, опутанных, бессознательных. Помеха: атака
                против невидимых, атаки от слепых, напуганных, отравленных,
                опутанных).
              </em>
            </p>

            <h3>
              <i className="fa-solid fa-hand-back-fist" /> Захват
            </h3>
            <ol>
              <li>
                Вы можете использовать действие «Атака» для совершения особой
                рукопашной атаки — захвата. Если вы можете совершать
                несколько атак, эта атака заменяет одну из них.
              </li>
              <li>
                Цель захвата должна быть не более чем на одну категорию
                больше вас, и она должна находиться в пределах вашей
                досягаемости.
              </li>
              <li>
                Используя как минимум одну свободную руку, вы совершаете
                проверку <strong>Атлетика</strong>, противопоставленную проверке{' '}
                <strong>Атлетика или Акробатика</strong> цели (цель сама
                выбирает).
              </li>
              <li>
                Проверка автоматически успешна, если цель недееспособна.
              </li>
              <li>
                Если вы преуспеете, цель становится <strong>схваченной</strong>.
                Вы можете отпустить цель в любой момент (действие не
                требуется).
              </li>
            </ol>

            <h3>
              <i className="fa-solid fa-person-running" /> Спринт (Рывок)
            </h3>
            <p>
              Если вы совершаете действие «Спринт», вы получаете
              дополнительное перемещение в текущем ходу, равное вашей
              скорости (после применения всех модификаторов).
            </p>

            <h3>
              <i className="fa-solid fa-person-through-window" />{' '}
              Высвобождение
            </h3>
            <ol>
              <li>
                <strong>Из захвата:</strong> Захваченное существо может
                пытаться высвободиться. Для этого оно <strong>действием</strong>{' '}
                совершает проверку Силы (Атлетика) или Ловкость (Акробатика),
                противопоставленную вашей проверке Силы (Атлетика).
              </li>
              <li>
                <strong>Из других условий (например оков):</strong> Может
                потребовать проверки Силы или Ловкости с обозначенной Сл.
              </li>
            </ol>

            <h3>
              <i className="fa-solid fa-users" /> Помощь
            </h3>
            <p>Вы можете помочь в одном из двух вариантов:</p>
            <ol>
              <li>
                Существо, которому вы помогаете, совершит свою следующую
                <strong> проверку характеристики</strong> с{' '}
                <strong>преимуществом</strong>, если она будет совершена до
                начала вашего следующего хода.
              </li>
              <li>
                Вы можете помочь дружественному существу атаковать (цель в
                пределах 5 футов от вас). Если ваш союзник атакует цель до
                начала вашего следующего хода, его первый бросок атаки
                совершается с <strong>преимуществом</strong>.
              </li>
            </ol>

            <h3>
              <i className="fa-solid fa-flask" /> Использование предмета
            </h3>
            <ol>
              <li>
                Обычно взаимодействие с предметами (вынуть меч, открыть
                дверь) является частью движения или атаки.
              </li>
              <li>
                Действие «Использование предмета» требуется, если предмет
                требует действия для использования, или если вы хотите
                использовать несколько предметов за один ход (например,
                достать зелье из рюкзака).
              </li>
              <li>
                Активация некоторых предметов (нажатие кнопки) требует
                действия.
              </li>
            </ol>

            <h3>
              <i className="fa-solid fa-user-secret" /> Засада (Скрытность)
            </h3>
            <ol>
              <li>
                Вы не можете прятаться от существа, которое видит вас. Если вы
                издадите шум, вы выдаёте своё местоположение.
              </li>
              <li>
                Когда вы пытаетесь спрятаться, совершите проверку{' '}
                <strong>Ловкости (Скрытность)</strong>.
              </li>
              <li>
                Результат этой проверки противостоит проверкам{' '}
                <strong>Мудрости (Восприятие)</strong> существ, активно ищущих
                вас.
              </li>
              <li>
                Мастер также сравнивает результат вашей Скрытности с{' '}
                <strong>пассивным значением внимательности</strong> врагов,
                чтобы определить, заметят ли вас без активных поисков.
              </li>
            </ol>

            <h3>
              <i className="fa-solid fa-wand-sparkles" /> Накладывание
              заклинания
            </h3>
            <ol>
              <li>
                Цель заклинания должна находиться в пределах дистанции
                заклинания и в прямой видимости (не за полным укрытием).
              </li>
              <li>
                <strong>Концентрация:</strong> Некоторые заклинания требуют
                концентрации. Вы можете окончить концентрацию в любое
                время (действие не требуется).
              </li>
              <li>
                Концентрация <strong>не прерывается</strong> перемещением или
                сражением.
              </li>
              <li>
                Концентрация <strong>прерывается</strong>:
                <ul>
                  <li>
                    Накладыванием другого заклинания, требующего концентрацию.
                  </li>
                  <li>Получением урона.</li>
                  <li>Недееспособностью, падением или смертью.</li>
                </ul>
              </li>
            </ol>

            <h3>
              <i className="fa-solid fa-dice" /> Импровизация (Действие)
            </h3>
            <p>
              Ваш персонаж может совершать действия, не описанные в этой
              главе, тогда все соответствующие проверки определяет мастер.
            </p>

            {/* ---------- БОНУСНЫЕ ДЕЙСТВИЯ ---------- */}

            <h2 className="article-section-break">
              <i className="fa-solid fa-bolt" /> Бонусные действия
            </h2>

            <h3>
              <i className="fa-solid fa-blender" /> Сражение двумя оружиями
            </h3>
            <ol>
              <li>
                Если вы совершаете действие «Атака» (с{' '}
                <strong>лёгким</strong> рукопашным оружием), вы можете{' '}
                <strong>бонусным действием</strong> атаковать другим
                <strong>лёгким</strong> рукопашным оружием, удерживаемым в
                другой руке.
              </li>
              <li>
                Вы <strong>не добавляете</strong> модификатор характеристики к
                урону от бонусной атаки (если только он не отрицательный).
              </li>
              <li>
                Если у оружия есть свойство «метательное», вы можете
                метнуть его вместо рукопашной атаки.
              </li>
            </ol>

            <h3>
              <i className="fa-solid fa-hand-point-right" /> Толчок
            </h3>
            <ol>
              <li>
                При помощи <strong>бонусного действия</strong> можно совершить
                особую рукопашную атаку, чтобы оттолкнуть цель от себя.
              </li>
              <li>
                Цель должна быть не более чем на одну категорию больше вас и
                в пределах досягаемости.
              </li>
              <li>
                Вы совершаете проверку <strong>Атлетика</strong>,
                противопоставленную проверке <strong>Атлетика</strong> цели.
                (Автоматический успех, если цель недееспособна).
              </li>
              <li>Если вы преуспеете, вы толкаете её на 5 футов от себя.</li>
            </ol>

            {/* ---------- РЕАКЦИИ ---------- */}

            <h2 className="article-section-break">
              <i className="fa-solid fa-burst" /> Реакция
            </h2>
            <p>
              Реакция — это мгновенный ответ на триггер, который может
              произойти как в ваш, так и в чужой ход.
            </p>

            <h3>
              <i className="fa-solid fa-angles-right" /> Спровоцированная
              атака
            </h3>
            <p>
              <strong>Триггер:</strong> Враждебное существо, которое вы
              видите, покидает вашу досягаемость.
            </p>
            <ol>
              <li>
                Вы совершаете одну рукопашную атаку по спровоцировавшему
                существу.
              </li>
              <li>
                Вы <strong>не провоцируете</strong> атаки, если
                телепортируетесь, или кто-то (что-то) перемещает вас, не
                тратя ваше перемещение, действие и реакцию.
              </li>
            </ol>

            <h3>
              <i className="fa-solid fa-star" /> Использование навыков
            </h3>
            <p>Некоторые навыки требуют траты реакции.</p>

            {/* ---------- РАЗГОВОР ---------- */}

            <h2 className="article-section-break">
              <i className="fa-solid fa-comments" /> Разговор
            </h2>
            <p>
              Вы можете общаться любыми доступными вам средствами, короткими
              фразами и жестами (обычно не требует затрат).
            </p>
          </article>
        </div>
      </main>
    </div>
  );
};

export default CombatRulePage;